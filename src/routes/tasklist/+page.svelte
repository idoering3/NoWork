<script lang='ts'>
    import { invoke } from "@tauri-apps/api/core";
    import Card from "$lib/Card.svelte";
    import Badge from "$lib/Badge.svelte";
    import type { Task } from "$lib/types/task";
    import TaskCard from "$lib/TaskCard.svelte";
    import Textbox from "$lib/Textbox.svelte";
    import Button from "$lib/Button.svelte";
    import ArrowUp from "@lucide/svelte/icons/arrow-up";
    import TagSelector from "$lib/TagSelector.svelte";
    import { ArrowDownUp, Network, Plus, Search, X } from "@lucide/svelte";
    import { onDestroy, onMount } from "svelte";
    import Datepicker from "$lib/DatePicker.svelte";
    import { fade, fly, scale, slide } from "svelte/transition";
    import { circInOut, quartInOut } from "svelte/easing";
    import { load, Store } from "@tauri-apps/plugin-store";

    let tasks: Task[] = $state([]);

    function handleKeydown(event: KeyboardEvent) {
        if (event.key === 'Enter') {
            submitTask();
        }
    }

    async function getIncompleteTasks() {
        tasks = await invoke('get_incomplete_tasks');
    }

    function sortTasksByDueDate(tasks: Task[]): Task[] {
        return [...tasks].sort((a, b) => {
            if (!a.dueDate && !b.dueDate) return 0; // both missing
            if (!a.dueDate) return 1; // a goes last
            if (!b.dueDate) return -1; // b goes last

            // Compare dates
            return new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime();
        });
    }

    let placeholders = [
        'steal grandma\'s bagel',
        'read War and Peace',
        'get absolutely wasted on a Tuesday morning',
        'scroll on social media for 6 hours',
        'add an item to my task list',
        'make a sad peanut butter jelly sandwich',
        'cry myself to sleep in a fetal position',
        'sigh heavily and gaze forlornly out the window',
        'talk to myself like a crazy person for an hour',
        'debate with my coffee whether it\'s time to quit or keep going',
        'become a conspiracy theorist',
        'run laps in the swivel chair around the cubicle',
        'make a playlist called \'songs to pretend you\'re working to\'',
        'try drinking a glass of milk while updside down',
        'bring a fishing pole to the aquarium',
        'call John and tell him I can\'t talk right now',
        'drive around in a clown costume like the clown I am',
        'streak through the streets, shouting Eureka!',
        'write a strongly worded email',
        'impersonate a drunk Lyndon B. Johnson looking for his car keys',
        'delete those incriminating Watergate tapes'
    ]

    let taskName = $state("");

    async function submitTask () {
        if (taskName) {
            await invoke('add_database_task', {name: taskName, dueDate: selectedDate?.toISOString(), tags: selectedTags});
            getIncompleteTasks();
            selectedTags = [];
            selectedDate = null;
            taskName = '';
        }
    }

    async function completeTask (taskId: number) {
        await invoke('complete_task', { taskId: taskId });
        getIncompleteTasks();
    }

    async function deleteTask (taskId: number) {
        await invoke("delete_task", {taskId: taskId});
        getIncompleteTasks();
    }

    async function getCompletedTaskCount (): Promise<number> {
        return await invoke<number>('get_completed_task_count');
    }

    function removeTagFromTask(tag: string) {
        selectedTags = selectedTags.filter(t => t !== tag);
    }

    let selectedTags: string[] = $state([]);
    let selectedDate: Date | null = $state(null);



	let taskContainer: HTMLDivElement;
	let header: HTMLHeadingElement;
	let taskBar: HTMLDivElement;

    function getOuterHeight(el: HTMLElement) {
        const style = getComputedStyle(el);
        const marginTop = parseFloat(style.marginTop) || 0;
        const marginBottom = parseFloat(style.marginBottom) || 0;
        return el.offsetHeight + marginTop + marginBottom;
    }

    function resize() {
        if (taskContainer && header && taskBar) {
            const style = getComputedStyle(taskContainer); 
            const marginTop = parseFloat(style.marginTop);
            const marginBottom = parseFloat(style.marginBottom);

            const availableHeight = window.innerHeight 
                - getOuterHeight(header) 
                - getOuterHeight(taskBar)
                - marginTop - marginBottom
                - 180;
            taskContainer.style.height = `${availableHeight}px`;
        }
    }

	onMount(() => {
		requestAnimationFrame(resize);
		window.addEventListener("resize", resize);
	});

	onDestroy(() => {
		window.removeEventListener("resize", resize);
	});

    interface SortOption {
        value: string,
        label: string
    }

    let sortOptions: SortOption[] = [
        { value:"due", label: "due date"},
        { value:"tag", label: "tag"}
    ]
    let sortIndex = $state(0);

    function changeSort() {
        if (sortIndex < sortOptions.length - 1) {
            sortIndex += 1; 
        } else {
            sortIndex = 0;
        }
    }

    let tags = $state([]);

    function dueToday(task: Task) {
        const dueDate: Date | null = task.dueDate ? new Date(task.dueDate) : null;
        const now: Date = new Date();
        if (dueDate?.toLocaleDateString() === now.toLocaleDateString()) {
            return true;
        }
        return false;
    }

    let selectedTag = $state("all");

    $effect(() => {
        (async () => {
            if (selectedTag) {
                if (selectedTag !== "all") {
                    if (!selectedTags.includes(selectedTag)) {
                        selectedTags = [selectedTag];
                    }
                } else {
                    selectedTags = [];
                }
                const store = await load(".settings.json");
                await store.set("selectedTag", selectedTag);
            }
        })();
    });

    onMount (async () => {
        getIncompleteTasks();
        const store = await load(".temp.json");
        const tag = await store.get<{ value: string }>("selectedTag");
        if (tag?.value) {
            selectedTag = tag.value;
            console.log(tag.value);
        }
    });

</script>

<div style="overflow: hidden; display: flex; height: calc(100vh - 3rem);">
    <div class='sidebar'>
        <p style="padding: 1rem; display:flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--border-color)">Tasks</p>
        <Button flavor="ghost" onclick={() => selectedTag = "all"}><span style={"all" === selectedTag ? "color:var(--highlight-color)" : ""}>all tasks</span></Button>
        {#each tags as tag}
            <Button flavor="ghost" onclick={() => selectedTag = tag}><span style={tag === selectedTag ? "color:var(--highlight-color)" : ""}>{tag}</span></Button>
        {/each}
        <Button flavor="ghost" Icon={Plus}></Button>
    </div>
    <div class='container'>
        <div class='header'>
            <h1 bind:this={header}>
                Task List
            </h1>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <h6>
                    {tasks.filter(task => dueToday(task)).length} task{tasks.filter(task => dueToday(task)).length !== 1 ? "s" : ''} due today
                </h6>
                <h6>
                    {#key tasks}
                        {#await getCompletedTaskCount() then completedTasks}
                            {completedTasks}
                            total tasks completed
                        {/await}
                    {/key}
                </h6>
            </div>
        </div>
        <div class='task-container' bind:this={taskContainer}>
            <div class='task-utilities'>
                <div class="sort">
                    <Button class="square small" flavor="primary" Icon={ArrowDownUp} onclick={changeSort} />
                    <p>
                        Sorting: 
                        {#key sortIndex}
                            <span style="position: absolute; padding-left: 0.25rem" 
                                in:fly={{ y:10, duration: 150, easing: quartInOut }} 
                                out:fly={{ y:-10, duration: 150, easing: quartInOut }}
                            >
                                {sortOptions[sortIndex].label}
                            </span>
                        {/key}
                    </p>
                </div>
            </div>
            <div style="position: relative;">
                {#key selectedTag}
                    <div style="position: absolute;" in:fly={{ duration: 300, y: 50, easing: circInOut}} out:fade={{ duration: 150, easing: quartInOut}}>
                        {#each sortTasksByDueDate(tasks) as task (task.id)}
                            {#if selectedTag !== "all"}
                                {#if task.tags?.some(tag => tag === selectedTag)}
                                    <TaskCard {task} onComplete={completeTask} onDelete={deleteTask}/>
                                {/if}
                            {:else}
                                <TaskCard {task} onComplete={completeTask} onDelete={deleteTask}/>
                            {/if}
                        {/each}
                    </div>
                {/key}
            </div>
        </div>
        
        <div class="task-bar" bind:this={taskBar}>
            <Card expanded class="short">
                <Textbox bind:value={taskName} onkeydown={(event: KeyboardEvent) => handleKeydown(event)} {placeholders} />
                {#snippet tagsn(name: string)}
                    <Badge flavor="outline" noPadding>
                        <span style="padding-left: 0.5rem">
                            {name}
                        </span>
                        <Button flavor="ghost" class="square xsmall circular" Icon={X}
                            onclick={() => {
                                removeTagFromTask(name);
                            }}
                        />
                    </Badge>
                {/snippet}
                {#if selectedTag !== "all"}
                    {@render tagsn(selectedTag)}
                {/if}
                {#each selectedTags as tag}
                    {#if selectedTag !== tag}
                        {@render tagsn(tag)}
                    {/if}
                {/each}
                {#if selectedDate}
                    {selectedDate.toLocaleDateString()}
                {/if}
                <TagSelector bind:selectedTags={selectedTags} refreshTags={getIncompleteTasks()} bind:allTags={tags} />
                <Datepicker bind:selectedDate={selectedDate}/>
                <Button onclick={submitTask} class="square" flavor="primary" Icon={ArrowUp} />
            </Card>
        </div>
    </div>
</div>

<style>
    .container {
        padding: 1rem 3rem;
        overflow: hidden;
    }

    .sidebar {
        width: 15rem;
        border-right: 1px solid var(--border-color);
        height: calc(100vh - 3rem);
    }

    p {
        font-size: 1rem;
    }

    .header {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .sort {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .task-utilities {
        display: flex;
        gap: 0.5rem;
        width: 100%;
    }

    .container {
		width: 100%;
		height: 100%;
        display: flex;
        flex-direction: column;
    }

    .task-container {
        position: relative;
        min-height: 0;
        overflow-y: auto;
        box-shadow: 0px 0px 5px -2px var(--border-color);
        border: 1px solid var(--border-color);
        background-color: var(--primary-light);
        border-radius: 15px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
</style>